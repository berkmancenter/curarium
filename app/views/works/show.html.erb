<script>

  window.onload = function() {

    // TODO: This should not be handled in JavaScript
    // view can do this on server
    // surrogates can be simple hyperlinks

    <% image = params[:image].to_i || 0%>
    window.work.display('<%= @work.images[image].image_url %>');
    $('img.surrogate_thumbnail').each( function(i){
      $(this).click(function(e){
        window.location = "?image="+i
      });    
    });
    
    // TODO: Move this stuff to its own JavaScript file in assets
    // or attempt to make it more HTML-based

  
    <%# if session[:user_id] %>
    //window.trays.add_work([<%= params[:id] %>],<%= session[:user_id].to_i%>);
    //window.work.update();
    <%# end %>
  
  };
</script>

<!-- BEGIN SUB MENU -->  
<div class="SUB_MENU bubble_menu">
  <table class="parsed-info"><tr>
    <td  class="bub_menu">
      <div class="menu_piecep">
      <label for='parsed_id'><span class="button">P</span></label>
      </div>
      <input type='checkbox' class='checkbox_hack' id='parsed_id'>
      <div class="expand_pi">
        <!-- THIS IS WHERE THE PARSED WORK INFORMATION GOES -->
        <%= render :partial => 'shared/print_metadata', :locals=>{:original=>@work.parsed,:current=>@current_metadata,:class_name=>'printed_object',:id_name=>'parsed_work'} %>
      </div>
    </td></tr>
    
    <tr>
    <td  class="bub_menu surrogates">
      <div class="menu_pieces">
      <label for='surrogates_id'><span class="button">S</span></label>
      </div>
      <input type='checkbox' class='checkbox_hack' id='surrogates_id'>
      <div class="expand_surr">
        <!-- THIS IS WHERE THE SURROGATE IMAGES GO -->
      <nav>
        <% @work.images.each { |i| %>
          <%= image_tag i.thumbnail_url, class: 'surrogate_thumbnail', alt: '' %>
        <% } %>
      </nav>
      </div>
    </td></tr>
    
    <tr>
    <td  class="bub_menu">
      <div class="menu_piecet">
        <label for='add_id'><span class="button">T</span></label>
        </div>
        <input type='checkbox' class='checkbox_hack' id='add_id'>
        <div class="expand_tray">
          <% if session[:user_id].present? %>

            <%= render template: 'trays/popup', layout: false %>

          <% end %>
        </div>
    </td></tr>

    <tr><td  class="bub_menu">
      <div class="menu_piecea">
        <label for='ann_id'><span class="button">A</span></label>
        </div>
        <input type='checkbox' class='checkbox_hack' id = 'ann_id'>
        <div class="expand_anno">
          <div id='annotations'>

            <% if session[:user_id] %>
              <h4 class='window_header'>ANNOTATE IMAGE</h4>
              <div class='window_body'>
                <div id='preview_window'></div>
                <%= form_for([@work, Annotation.new]) do |f| %>
                  <div>
                    <%= f.label :title%><br>
                    <%= f.text_field :title%>
                  </div>
                  <div>
                    <%= f.label :body%><br>
                    <%= f.text_area :body%>
                  </div>
                  <%#= f.hidden_field :tags, id: 'content_tags' %>

                  <%= f.hidden_field :x, id: 'content_x' %>
                  <%= f.hidden_field :y, id: 'content_y'%>
                  <%= f.hidden_field :width, id: 'content_width'%>
                  <%= f.hidden_field :height, id: 'content_height'%>
                  <%= f.hidden_field :image_url, id: 'content_image_url'%>
                  <%= f.hidden_field :thumbnail_url, id: 'content_thumbnail_url'%>

                  <%#= tag_selector @current_metadata %>
                  <p>
                  <%= f.submit %>
                  </p>
                <% end %>    
              </div>
            <% end %>

            <div id='work_annotations'>
              <% @work.annotations.each do |annotation| %>
                <div class='annotation_wrapper' id='note_<%= annotation.id%>'>
                  <p class='annotation_title'>
                  <%= annotation.title %>
                  </p>
                  <p class='annotation_body'>
                  <%= annotation.body %>
                  </p>
                  <% unless annotation.tags.nil? %>
                    <div class='annotation_tags'>
                      <% annotation.tags.split( ',' ).each do |tag| %>
                        <p class='annotation_tag'>
                        <%= tag %>
                        </p>
                      <% end %>
                    </div>
                  <% end %>
                  <p class='annotation_attribution'>
                  by <%= annotation.user.name unless annotation.user.nil? %> on <%= annotation.created_at %>
                  </p>
                </div>
              <% end %>
            </div>

          </div> 
        </div>
        </td>
  </tr></table>

</div><!-- END SUB MENU -->  

<!-- BEGIN COLLECTION CREDIT -->
    <div class="credit"><a href="">Collection provided by <%= @work.collection.source %></a></div>
<!-- END COLLECTION CREDIT -->
